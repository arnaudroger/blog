<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>ArrayList.get(i) vs array[i]</title>
  <meta name="description" content="I recently did a presentation at the Belfast JUG about some work I did try to optimise the Re2j library.">

  <link rel="stylesheet" href="/blog/assets/main.css">
  <link rel="canonical" href="http://arnaudroger.github.io/blog/2018/06/01/arraylist-vs-arrays.html">
  <link rel="alternate" type="application/rss+xml" title="Eat Sleep Code Repeat." href="/blog/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" href="/blog/">Eat Sleep Code Repeat.</a>

    <nav class="site-nav">
      <span class="menu-icon">
        <svg viewBox="0 0 18 15" width="18px" height="15px">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </span>

      <div class="trigger">
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">ArrayList.get(i) vs array[i]</h1>
        <p class="post-meta"><time datetime="2018-06-01T00:00:00+01:00" itemprop="datePublished">Jun 1, 2018</time></p>
    </header>

    <div class="post-content" itemprop="articleBody">
        <p>I recently did a <a href="https://slides.com/arnaudroger/when-micro-optimisation-matters/">presentation</a> at the <a href="https://www.meetup.com/BelfastJUG/">Belfast JUG</a> about some work I did try to optimise the Re2j library.</p>

<p>One of the first changes I made was replacing 2 ArrayList by 2 Arrays. That lead to a 10% perf improvement in my benchmark
which was quite big for such a simple change, I assumed that it was mainly due to the size check removal but it was not the full story.</p>

<p>In this blog post, I will try to dig deeper as to where the performance improvement actually came from.</p>

<p>We will first have a look at random access and then sequential access.
For both access patterns, I started with an accidentally flawed benchmark, which we will go through for education purpose. 
The final result - unless some other issue is discovered later - is in the TL;DR, if you are not interested in how easy it is to mess up a benchmark.</p>

<h1 id="tldr">TL;DR</h1>

<p>Random <code class="highlighter-rouge">ArrayList</code> access is about 6% more expensive because of the size check and cast check introduced in the <code class="highlighter-rouge">ArrayList</code>.</p>

<p><em>Random access average invocation time</em></p>

<p><img src="/blog/images/05_arraylists_vs_arrays/Random2Access.png" alt="RandomAccess-avgt" /></p>

<p>For sequential access it seems <code class="highlighter-rouge">Array</code> can be a lot faster especially for smaller ones. 
On the long add loop, there is 50% perf difference for 10 elements, 80% on a 1000 elements, but that number may only apply to an add loop, allowing for more optimisations.
It’s hard to tell if those numbers can be generalised to other kinds of work than numerical one.</p>

<p><em>Sequential access average time of 1 get</em></p>

<p><img src="/blog/images/05_arraylists_vs_arrays/Seq2Access.png" alt="SeqAccess avgt/size" /></p>

<h1 id="a-word-about-arrayliste">A word about <code class="highlighter-rouge">ArrayList&lt;E&gt;</code></h1>

<p><code class="highlighter-rouge">ArrayList&lt;E&gt;</code> provide a List implementation backed by an <code class="highlighter-rouge">Object[]</code>. 
Why not an use <code class="highlighter-rouge">E[]</code>? Because of erasure, the actual type <code class="highlighter-rouge">E</code> of the <code class="highlighter-rouge">ArrayList</code> is lost at runtime.</p>

<p>The code to do a <code class="highlighter-rouge">ArrayList.get(index)</code> is then equivalent to</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
</code></pre>
</div>

<h1 id="random-access">Random Access</h1>

<p>In this section, we will look at the random access pattern, where we will do a read at random index on each invocation.</p>

<p>The data is just a <code class="highlighter-rouge">Long[]</code> or ArrayList<Long> filled with random value of the specified size.</Long></p>

<h2 id="randomaccess-benchmark-try-1">RandomAccess Benchmark Try 1</h2>

<h3 id="randomarrayaccess"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/src/main/java/com/github/arnaudroger/RandomArrayAccess.java#L24">RandomArrayAccess</a></h3>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="nd">@Setup</span><span class="o">(</span><span class="n">Level</span><span class="o">.</span><span class="na">Invocation</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">nextIndex</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="n">Long</span> <span class="nf">testGet</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
    <span class="o">}</span>
</code></pre>
</div>

<h3 id="randomlistaccess"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/src/main/java/com/github/arnaudroger/RandomListAccess.java#L24">RandomListAccess</a></h3>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="nd">@Setup</span><span class="o">(</span><span class="n">Level</span><span class="o">.</span><span class="na">Invocation</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">nextIndex</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="n">Long</span> <span class="nf">testGet</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre>
</div>

<h3 id="randomaccess-results"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Ite1-jmh-result.csv#L2">RandomAccess results</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>java -jar target/benchmark.jar -bm avgt -tu ns
</code></pre>
</div>

<p>In the following result, you can see a 10% penalty for using <code class="highlighter-rouge">ArrayList</code>, 
and a massive 160% difference for a 1 million elements array, which is pretty suspicious.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Benchmark                          (size)  Mode  Cnt        Score       Error  Units

RandomArrayAccess.testGet              10  avgt  200       20.983 ±     0.229  ns/op
RandomListAccess.testGet               10  avgt  200       23.161 ±     0.097  ns/op

RandomArrayAccess.testGet            1000  avgt  200       20.600 ±     0.074  ns/op
RandomListAccess.testGet             1000  avgt  200       23.457 ±     0.133  ns/op

RandomArrayAccess.testGet         1000000  avgt  200       33.545 ±     0.035  ns/op
RandomListAccess.testGet          1000000  avgt  200       90.301 ±     0.246  ns/op
</code></pre>
</div>

<h3 id="randomarrayaccess-asm"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/RandomArrayAccess.testGet10.asm#L97">RandomArrayAccess asm</a></h3>

<div class="highlighter-rouge"><pre class="highlight"><code>java -jar target/benchmark.jar -bm avgt -tu ns -f 1 -prof perfasm Random
</code></pre>
</div>

<p>The <a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/RandomArrayAccess.testGet10.asm#L97">asm for array access</a> is pretty simple.</p>
<ol>
  <li>load the index
    <pre><code class="language-asm">  0.40%            0x00007f85e12274c3: mov    %rax,0x10(%rsp)    ; 
                   0x00007f85e12274c8: mov    0x70(%rsp),%r10
                   0x00007f85e12274cd: mov    0x10(%r10),%r10d   ;*getfield index
                                                                 ; - com.github.arnaudroger.RandomArrayAccess::testGet@5 (line 69)
                                                                 ; - com.github.arnaudroger.generated.RandomArrayAccess_testGet_jmhTest::testGet_avgt_jmhStub@149 (line 439)
</code></pre>
  </li>
  <li>load the array address
    <pre><code class="language-asm">  0.76%    0.05%   0x00007f85e12274d1: mov    0x70(%rsp),%r11    ; 
                   0x00007f85e12274d6: mov    0x14(%r11),%r8d    ;*getfield data
                                                                 ; - com.github.arnaudroger.RandomArrayAccess::testGet@1 (line 69)
                                                                 ; - com.github.arnaudroger.generated.RandomArrayAccess_testGet_jmhTest::testGet_avgt_jmhStub@149 (line 439)
</code></pre>
  </li>
  <li>implicit boundary check
    <pre><code class="language-asm">  0.32%    0.53%   0x00007f85e12274da: mov    0xc(%r12,%r8,8),%r9d  ; implicit exception: dispatches to 0x00007f85e1227895 
  1.94%    6.06%   0x00007f85e12274df: cmp    %r9d,%r10d
                   0x00007f85e12274e2: jae    0x00007f85e1227605
</code></pre>
  </li>
  <li>load the element
    <pre><code class="language-asm">  0.68%    2.19%   0x00007f85e12274e8: lea    (%r12,%r8,8),%r11  ; 
                   0x00007f85e12274ec: mov    0x10(%r11,%r10,4),%r10d
                   0x00007f85e12274f1: mov    %r10,%rdx
                   0x00007f85e12274f4: shl    $0x3,%rdx          ;*aaload
                                                                 ; - com.github.arnaudroger.RandomArrayAccess::testGet@8 (line 69)
                                                                 ; - com.github.arnaudroger.generated.RandomArrayAccess_testGet_jmhTest::testGet_avgt_jmhStub@149 (line 439)
</code></pre>
  </li>
</ol>

<h3 id="randomlistaccess-asm"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/RandomListAccess.testGet10.asm#L200">RandomListAccess asm</a></h3>

<p>The <a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/RandomListAccess.testGet10.asm#L200"><code class="highlighter-rouge">ArrayList</code></a> has a lot more going on</p>
<ol>
  <li>load the index
    <pre><code class="language-asm">  0.18%           │  0x00007fa82d25427b: mov    %rax,0x10(%rsp)    ;
                  │  0x00007fa82d254280: mov    0x70(%rsp),%r10
                  │  0x00007fa82d254285: mov    0x10(%r10),%r8d    ;*getfield index
                  │                                                ; - com.github.arnaudroger.RandomListAccess::testGet@5 (line 85)
                  │                                                ; - com.github.arnaudroger.generated.RandomListAccess_testGet_jmhTest::testGet_avgt_jmhStub@149 (line 439)
</code></pre>
  </li>
  <li>load the ArrayList address
    <pre><code class="language-asm">  0.42%    0.70%  │  0x00007fa82d254289: mov    0x14(%r10),%r10d   ;*getfield data
                  │                                                ; - com.github.arnaudroger.RandomListAccess::testGet@1 (line 85)
                  │                                                ; - com.github.arnaudroger.generated.RandomListAccess_testGet_jmhTest::testGet_avgt_jmhStub@149 (line 439)
</code></pre>
  </li>
  <li>load the size
    <pre><code class="language-asm">                  │  0x00007fa82d25428d: mov    0x10(%r12,%r10,8),%r11d  ;*getfield size 
                  │                                                ; - java.util.ArrayList::rangeCheck@2 (line 652)
                  │                                                ; - java.util.ArrayList::get@2 (line 429)
                  │                                                ; - com.github.arnaudroger.RandomListAccess::testGet@8 (line 85)
                  │                                                ; - com.github.arnaudroger.generated.RandomListAccess_testGet_jmhTest::testGet_avgt_jmhStub@149 (line 439)
                  │                                                ; implicit exception: dispatches to 0x00007fa82d254785
</code></pre>
  </li>
  <li>do the range check index &lt; size
    <pre><code class="language-asm">  0.96%    3.38%  │  0x00007fa82d254292: cmp    %r11d,%r8d         ; 
                  │  0x00007fa82d254295: jge    0x00007fa82d254625  ;*if_icmplt
                  │                                                ; - java.util.ArrayList::rangeCheck@5 (line 652)
                  │                                                ; - java.util.ArrayList::get@2 (line 429)
                  │                                                ; - com.github.arnaudroger.RandomListAccess::testGet@8 (line 85)
                  │                                                ; - com.github.arnaudroger.generated.RandomListAccess_testGet_jmhTest::testGet_avgt_jmhStub@149 (line 439)
</code></pre>
  </li>
  <li>load the underlying elementData array address
    <pre><code class="language-asm">  0.42%    0.88%  │  0x00007fa82d25429b: mov    0x14(%r12,%r10,8),%r11d  ;*getfield elementData
                  │                                                ; - java.util.ArrayList::elementData@1 (line 418)
                  │                                                ; - java.util.ArrayList::get@7 (line 431)
                  │                                                ; - com.github.arnaudroger.RandomListAccess::testGet@8 (line 85)
                  │                                                ; - com.github.arnaudroger.generated.RandomListAccess_testGet_jmhTest::testGet_avgt_jmhStub@149 (line 439)
</code></pre>
  </li>
  <li>implicit boundary check
    <pre><code class="language-asm">                  │  0x00007fa82d2542a0: mov    0xc(%r12,%r11,8),%r10d  ; implicit exception: dispatches to 0x00007fa82d2547a9
  0.99%    2.44%  │  0x00007fa82d2542a5: cmp    %r10d,%r8d
                  │  0x00007fa82d2542a8: jae    0x00007fa82d254459
</code></pre>
  </li>
  <li>and 8 load the element and checkcast
    <div class="highlighter-rouge"><pre class="highlight"><code>                  │  0x00007fa82d2542b2: mov    0x10(%r10,%r8,4),%r10d  ;*aaload
                  │                                                ; - java.util.ArrayList::elementData@5 (line 418)
                  │                                                ; - java.util.ArrayList::get@7 (line 431)
                  │                                                ; - com.github.arnaudroger.RandomListAccess::testGet@8 (line 85)
                  │                                                ; - com.github.arnaudroger.generated.RandomListAccess_testGet_jmhTest::testGet_avgt_jmhStub@149 (line 439)
                  │  0x00007fa82d2542b7: mov    0x8(%r12,%r10,8),%r8d  ; implicit exception: dispatches to 0x00007fa82d2547cd
  0.92%    1.64%  │  0x00007fa82d2542bc: cmp    $0xf80022ae,%r8d   ;   {metadata(&amp;apos;java/lang/Long&amp;apos;)}
                  │  0x00007fa82d2542c3: jne    0x00007fa82d2546f5
  0.16%    0.01%  │  0x00007fa82d2542c9: lea    (%r12,%r10,8),%rdx  ;*checkcast
                  │                                                ; - com.github.arnaudroger.RandomListAccess::testGet@11 (line 85)
                  │                                                ; - com.github.arnaudroger.generated.RandomListAccess_testGet_jmhTest::testGet_avgt_jmhStub@149 (line 439)
</code></pre>
    </div>
  </li>
</ol>

<p>Note that the <code class="highlighter-rouge">checkcast</code> and the element load are interleaved together in the asm. the <code class="highlighter-rouge">lea</code> - load effective address - instruction is wrongly annotated as the <code class="highlighter-rouge">checkcast</code> here when it is the actual array access.</p>

<p>that can explain the 10% difference between <code class="highlighter-rouge">ArrayList.get(i)</code> and <code class="highlighter-rouge">Array[i]</code>.</p>

<p>What explains the 160% difference though on the 1000000 size?</p>

<p>if you look at the <a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/RandomListAccess.testGet1000000.asm#L117">perf asm result for the 1000000 size</a>.</p>

<pre><code class="language-asm">  0.31%    1.22%  │  │  0x00007f0a152457e9: lea    (%r12,%r11,8),%r10
                  │  │  0x00007f0a152457ed: mov    0x10(%r10,%r8,4),%r10d  ;*aaload
                  │  │                                                ; - java.util.ArrayList::elementData@5 (line 418)
                  │  │                                                ; - java.util.ArrayList::get@7 (line 431)
                  │  │                                                ; - com.github.arnaudroger.RandomListAccess::testGet@8 (line 85)
                  │  │                                                ; - com.github.arnaudroger.generated.RandomListAccess_testGet_jmhTest::testGet_avgt_jmhStub@149 (line 439)
 10.89%    5.39%  │  │  0x00007f0a152457f2: mov    0x8(%r12,%r10,8),%r8d  ; implicit exception: dispatches to 0x00007f0a15245e19
 34.86%    0.32%  │  │  0x00007f0a152457f7: cmp    $0xf80022ae,%r8d   ;   {metadata(&amp;apos;java/lang/Long&amp;apos;)}
                  │  │  0x00007f0a152457fe: jne    0x00007f0a15245d41
  0.21%           │  │  0x00007f0a15245804: lea    (%r12,%r10,8),%rdx  ;*checkcast
                  │  │                                                ; - com.github.arnaudroger.RandomListAccess::testGet@11 (line 85)
                  │  │                                                ; - com.github.arnaudroger.generated.RandomListAccess_testGet_jmhTest::testGet_avgt_jmhStub@149 (line 439)
</code></pre>

<p>It spent 34% of the cycles on <code class="highlighter-rouge">checkcast</code>!</p>

<p>Now if we look at the <a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/RandomPerfNorm1000000#L250">perfnorm profile</a> :</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Benchmark                                         (size)   Mode  Cnt         Score       Error  Units
RandomArrayAccess.testGet:CPI                    1000000  thrpt              0.982               #/op
RandomListAccess.testGet:CPI                     1000000  thrpt              1.606               #/op

RandomArrayAccess.testGet:L1-dcache-load-misses  1000000  thrpt              1.004               #/op
RandomListAccess.testGet:L1-dcache-load-misses   1000000  thrpt              3.098               #/op

RandomArrayAccess.testGet:LLC-loads              1000000  thrpt              0.944               #/op
RandomListAccess.testGet:LLC-loads               1000000  thrpt              2.138               #/op

RandomArrayAccess.testGet:branches               1000000  thrpt             56.780               #/op
RandomListAccess.testGet:branches                1000000  thrpt             59.068               #/op

RandomArrayAccess.testGet:cycles                 1000000  thrpt            324.400               #/op
RandomListAccess.testGet:cycles                  1000000  thrpt            541.267               #/op

RandomArrayAccess.testGet:instructions           1000000  thrpt            330.514               #/op
RandomListAccess.testGet:instructions            1000000  thrpt            336.976               #/op
</code></pre>
</div>

<p>The biggest difference is the number of L1 cache misses, 3 times as many. In the <code class="highlighter-rouge">Array</code> case because we don’t do anything with the <code class="highlighter-rouge">Long</code>, we will cache miss only on the <code class="highlighter-rouge">lea</code> instruction. 
But in the <code class="highlighter-rouge">ArrayList</code> we need to do a <code class="highlighter-rouge">checkcast</code>, to do that we need to read the memory where the <code class="highlighter-rouge">Long</code> resides increasing the chances of a cache miss.</p>

<p>In a real application we are likely to do something with the element of the <code class="highlighter-rouge">Array</code>, it is therefore not a fair benchmark. That issue is also likely to impact the smaller size <code class="highlighter-rouge">Array</code>.</p>

<h2 id="randomaccess-benchmark---try-2">RandomAccess Benchmark - Try 2</h2>

<p>We can force a read of the value easily by returning a <code class="highlighter-rouge">long</code> instead of <code class="highlighter-rouge">Long</code> triggering an unboxing call of longValue().</p>

<h3 id="random2arrayaccess"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/src/main/java/com/github/arnaudroger/Random2ArrayAccess.java#L22">Random2ArrayAccess</a></h3>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">testGet</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
    <span class="o">}</span>
</code></pre>
</div>
<h3 id="random2listaccess"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/src/main/java/com/github/arnaudroger/Random2ListAccess.java#L23">Random2ListAccess</a></h3>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">testGet</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="o">}</span>

</code></pre>
</div>

<h3 id="avgt"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Random2-jmh-result.csv">avgt</a></h3>

<p>As you can see in the following table and graph, the result looks more consistent with 7-6% performance penalty on the ArrayList.</p>

<p><img src="/blog/images/05_arraylists_vs_arrays/Random2Access.png" alt="RandomAccess-avgt" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>Benchmark                    (size)  Mode  Cnt   Score   Error  Units
Random2ArrayAccess.testGet       10  avgt  200  21.938 ± 0.032  ns/op
Random2ListAccess.testGet        10  avgt  200  23.489 ± 0.039  ns/op
Random2ArrayAccess.testGet     1000  avgt  200  22.252 ± 0.030  ns/op
Random2ListAccess.testGet      1000  avgt  200  23.764 ± 0.050  ns/op
Random2ArrayAccess.testGet  1000000  avgt  200  89.436 ± 0.224  ns/op
Random2ListAccess.testGet   1000000  avgt  200  94.676 ± 0.240  ns/op
</code></pre>
</div>

<h3 id="random2-asm"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Random2.perfasm">Random2 Asm</a></h3>

<p>I will skip on the full asm for that one. It is very similar to Try 1 with an additional <a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Random2.perfasm#L610">longValue call</a>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  0.43%    0.19%    │  0x00007f0eb5243aaf: mov    0x10(%r12,%r10,8),%rdx  ;*getfield value
                    │                                                ; - java.lang.Long::longValue@1 (line 1000)
                    │                                                ; - com.github.arnaudroger.Random2ArrayAccess::testGet@9 (line 67)
                    │                                                ; - com.github.arnaudroger.generated.Random2ArrayAccess_testGet_jmhTest::testGet_avgt_jmhStub@149 (line 439)
                    │                                                ; implicit exception: dispatches to 0x00007f0eb5243f45
</code></pre>
</div>

<h1 id="sequential-access">Sequential Access</h1>

<p>Let’s now have a look at sequential access.</p>

<h2 id="sequential-benchmark-try-1">Sequential Benchmark Try 1</h2>

<p>we will just iterate over the <code class="highlighter-rouge">Array</code>/<code class="highlighter-rouge">ArrayList</code> and pass the value to the <code class="highlighter-rouge">Blackhole</code> to protect against dead code elimination.</p>

<h3 id="seqarrayaccess"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/src/main/java/com/github/arnaudroger/SeqArrayAccess.java#L23">SeqArrayAccess</a></h3>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGet</span><span class="o">(</span><span class="n">Blackhole</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Long</span> <span class="n">l</span> <span class="o">:</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">b</span><span class="o">.</span><span class="na">consume</span><span class="o">(</span><span class="n">l</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h3 id="seqlistaccess"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/src/main/java/com/github/arnaudroger/SeqListAccess.java#L24">SeqListAccess</a></h3>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testNewForEach</span><span class="o">(</span><span class="n">Blackhole</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">data</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nl">b:</span><span class="o">:</span><span class="n">consume</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testClassicForEach</span><span class="o">(</span><span class="n">Blackhole</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Long</span> <span class="n">l</span> <span class="o">:</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">b</span><span class="o">.</span><span class="na">consume</span><span class="o">(</span><span class="n">l</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testIndexed</span><span class="o">(</span><span class="n">Blackhole</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">data</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">b</span><span class="o">.</span><span class="na">consume</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h3 id="avgt-1"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Ite1-jmh-result.csv#L8">Avgt</a></h3>

<p>In the sequential access the number are consistent across size, with at least 45% penalty across the board.
ArrayList indexed access is faster, then for each loop, then ArrayList.forEach - that would in itself deserve some more analysis, but for now I will focus on the indexed access.
But beware we will need to check that does not number are actually representative of a real use case - and as we will see it it not.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>SeqArrayAccess.testGet            1000000  avgt  200  2633544.985 ±  2389.151  ns/op
SeqListAccess.testIndexed         1000000  avgt  200  3720347.588 ±  7958.779  ns/op
SeqListAccess.testClassicForEach  1000000  avgt  200  4251067.025 ± 11038.199  ns/op
SeqListAccess.testNewForEach      1000000  avgt  200  4435148.392 ± 41712.575  ns/op
</code></pre>
</div>

<h3 id="x86-asm">x86 asm</h3>

<h4 id="seqarray"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/SeqArrayAccess.asm#L132">SeqArray</a></h4>

<p>What can we see in the asm for the <code class="highlighter-rouge">Array</code> is pretty simple.</p>
<ol>
  <li>load data from (%rsp)
    <pre><code class="language-asm">  9.90%   10.66%  ││↗  0x00007f269d22f4c1: mov    (%rsp),%r10        ;*aload_2
                  │││                                                ; - com.github.arnaudroger.SeqArrayAccess::testGet@17 (line 61)
                  │↘│  0x00007f269d22f4c5: mov    0x10(%r10,%rbp,4),%r11d
  0.70%    0.54%  │ │  0x00007f269d22f4ca: mov    %r10,(%rsp)
  0.04%    0.03%  │ │  0x00007f269d22f4ce: mov    %r11,%rdx
</code></pre>
  </li>
  <li>load element - no boundary check
    <pre><code class="language-asm">  9.47%    8.56%  │ │  0x00007f269d22f4d1: shl    $0x3,%rdx          ;*aaload
                  │ │                                                ; - com.github.arnaudroger.SeqArrayAccess::testGet@20 (line 61)
  0.18%    0.06%  │ │  0x00007f269d22f4d5: mov    0x8(%rsp),%rsi
</code></pre>
  </li>
  <li>call consume
    <pre><code class="language-asm">  0.01%    0.04%  │ │  0x00007f269d22f4da: nop
  0.05%    0.03%  │ │  0x00007f269d22f4db: callq  0x00007f269d046020  ; OopMap{[0]=Oop [8]=Oop off=128}
                  │ │                                                ;*invokevirtual consume
                  │ │                                                ; - com.github.arnaudroger.SeqArrayAccess::testGet@26 (line 62)
                  │ │                                                ;   {optimized virtual_call}
</code></pre>
  </li>
  <li>increment counter - ebp
    <pre><code class="language-asm"> 10.35%   13.07%  │ │  0x00007f269d22f4e0: inc    %ebp               ;*iinc
                  │ │                                                ; - com.github.arnaudroger.SeqArrayAccess::testGet@29 (line 61)
</code></pre>
  </li>
  <li>check counter against size - 0x10(%rsp), loop
    <pre><code class="language-asm">  0.03%    0.03%  │ │  0x00007f269d22f4e2: cmp    0x10(%rsp),%ebp
                  │ ╰  0x00007f269d22f4e6: jl     0x00007f269d22f4c1  ;*if_icmpge
                  │                                                  ; - com.github.arnaudroger.SeqArrayAccess::testGet@14 (line 61)
</code></pre>
    <h4 id="seqlistaccessindexed"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/SeqListAccessIndexed.asm#L86">SeqListAccessIndexed</a></h4>
  </li>
</ol>

<p>for the <code class="highlighter-rouge">ArrayList</code> indexed access there is a bit more happening.</p>
<ol>
  <li>load data
    <pre><code class="language-asm">                    0x00007f2925225ec7: lea    (%r12,%r11,8),%rcx  ;*getfield data
                                                                  ; - com.github.arnaudroger.SeqListAccess::testIndexed@1 (line 74)
</code></pre>
  </li>
  <li>load data.size
    <pre><code class="language-asm">  6.59%    4.76%     │ ↗  0x00007f2925225ed2: mov    0x8(%rsp),%r11d
                  │ │  0x00007f2925225ed7: mov    0x10(%r12,%r11,8),%r10d  ;*getfield size
                  │ │                                                ; - java.util.ArrayList::rangeCheck@2 (line 652)
                  │ │                                                ; - java.util.ArrayList::get@2 (line 429)
                  │ │                                                ; - com.github.arnaudroger.SeqListAccess::testIndexed@23 (line 77)
</code></pre>
  </li>
  <li>range check test
    <pre><code class="language-asm">                  ↘ │  0x00007f2925225eea: cmp    %r10d,%ebp
                    │  0x00007f2925225eed: jge    0x00007f2925225f65  ;*if_icmplt
                    │                                                ; - java.util.ArrayList::rangeCheck@5 (line 652)
                    │                                                ; - java.util.ArrayList::get@2 (line 429)
                    │                                                ; - com.github.arnaudroger.SeqListAccess::testIndexed@23 (line 77)
</code></pre>
  </li>
  <li>load data.elementData
    <pre><code class="language-asm">  0.15%    0.08%    │  0x00007f2925225eef: mov    0x14(%r12,%r11,8),%r10d  ;*getfield elementData
                    │                                                ; - java.util.ArrayList::elementData@1 (line 418)
                    │                                                ; - java.util.ArrayList::get@7 (line 431)
                    │                                                ; - com.github.arnaudroger.SeqListAccess::testIndexed@23 (line 77)
</code></pre>
  </li>
  <li>implicit boundary check - why not eliminated?
    <pre><code class="language-asm">  1.40%    1.46%    │  0x00007f2925225ef4: mov    0xc(%r12,%r10,8),%r8d  ; implicit exception: dispatches to 0x00007f2925225fb6
  9.69%   10.38%    │  0x00007f2925225ef9: cmp    %r8d,%ebp
                  ╭│  0x00007f2925225efc: jae    0x00007f2925225f40
</code></pre>
  </li>
  <li>load element - no check cast here as consume take an Object so not needed
    <pre><code class="language-asm">  3.95%    4.98%   ││  0x00007f2925225efe: mov    %rcx,0x10(%rsp)
  0.04%    0.03%   ││  0x00007f2925225f03: mov    %r9d,0xc(%rsp)
  0.49%    0.50%   ││  0x00007f2925225f08: mov    %r11d,0x8(%rsp)
  2.68%    2.58%   ││  0x00007f2925225f0d: mov    %rdx,(%rsp)
  3.80%    3.86%   ││  0x00007f2925225f11: shl    $0x3,%r10
  0.04%    0.07%   ││  0x00007f2925225f15: mov    0x10(%r10,%rbp,4),%r11d
  4.53%    3.99%   ││  0x00007f2925225f1a: mov    %r11,%rdx
  2.14%    2.49%   ││  0x00007f2925225f1d: shl    $0x3,%rdx          ;*aaload
                   ││                                                ; - java.util.ArrayList::elementData@5 (line 418)
                   ││                                                ; - java.util.ArrayList::get@7 (line 431)
                   ││                                                ; - com.github.arnaudroger.SeqListAccess::testIndexed@23 (line 77)
</code></pre>
  </li>
  <li>call consumer
    <pre><code class="language-asm">  4.24%    4.03%   ││  0x00007f2925225f21: mov    (%rsp),%rsi
  0.11%    0.06%   ││  0x00007f2925225f25: xchg   %ax,%ax
  0.49%    0.37%   ││  0x00007f2925225f27: callq  0x00007f2925046020  ; OopMap{[0]=Oop [8]=NarrowOop [16]=Oop off=172}
                   ││                                                ;*invokevirtual consume
                   ││                                                ; - com.github.arnaudroger.SeqListAccess::testIndexed@26 (line 77)
                   ││                                                ;   {optimized virtual_call}
</code></pre>
  </li>
  <li>inc counter and check against size - 0x10(%rsp), loop to 2
    <pre><code class="language-asm">  6.70%    5.13%   ││  0x00007f2925225f2c: inc    %ebp               ;*iinc
                   ││                                                ; - com.github.arnaudroger.SeqListAccess::testIndexed@29 (line 76)
  0.11%    0.08%   ││  0x00007f2925225f2e: cmp    0xc(%rsp),%ebp
                   │╰  0x00007f2925225f32: jl     0x00007f2925225ed2  ;*if_icmpge
                   │                                                 ; - com.github.arnaudroger.SeqListAccess::testIndexed@16 (line 76)
</code></pre>
  </li>
</ol>

<p>So the cast has been removed - as the <code class="highlighter-rouge">Blackhole</code> takes an Object -, which is unlikely to happen in real world app. 
but the boundary check elimination did not happen because consume is blocking that optimisation.</p>

<p>That benchmark is probably not good for what we want to analyse there….</p>

<h2 id="sequential---try-2">Sequential - Try 2</h2>

<p>Will avoid using the <code class="highlighter-rouge">Blackhole</code> in the loop by just calculating the sum of the elements and returning it.</p>

<h3 id="seq2arrayaccess"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/src/main/java/com/github/arnaudroger/Seq2ArrayAccess.java#L19">Seq2ArrayAccess</a></h3>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">testGet</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Long</span> <span class="n">l</span> <span class="o">:</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">l</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">total</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre>
</div>

<h3 id="seq2listaccess"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/src/main/java/com/github/arnaudroger/Seq2ListAccess.java#L21">Seq2ListAccess</a></h3>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">testIndexed</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">data</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">total</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre>
</div>

<h3 id="avgt-2"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Seq2.log#L2697">avgt</a></h3>
<p><img src="/blog/images/05_arraylists_vs_arrays/Seq2Access.png" alt="RandomAccess-avgt" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>Benchmark                    (size)  Mode  Cnt        Score      Error  Units
Seq2ArrayAccess.testGet          10  avgt  200        7.653 ±    0.017  ns/op
Seq2ListAccess.testIndexed       10  avgt  200       11.702 ±    0.120  ns/op
Seq2ArrayAccess.testGet        1000  avgt  200      320.084 ±    0.616  ns/op
Seq2ListAccess.testIndexed     1000  avgt  200      585.754 ±    0.471  ns/op
Seq2ArrayAccess.testGet     1000000  avgt  200  1620174.088 ± 2663.118  ns/op
Seq2ListAccess.testIndexed  1000000  avgt  200  1681210.020 ± 3470.300  ns/op
</code></pre>
</div>

<p>here we can still see a big penalty - 50%, 80%, 3% - on the ArrayList with a big convergence of perf for bigger arrays.</p>

<h3 id="x86-asm-1">x86 asm</h3>

<p>The asm is quite interesting on the size of 10.</p>

<h4 id="seq2array-asm"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Seq2ArrayAccess10.asm#L124">Seq2Array asm</a></h4>

<p>there is a lot more asm generated. You can see that the loop is first <a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Seq2ArrayAccess10.asm#L124-L189">unrolled</a> and then loop one by one :</p>

<div class="highlighter-rouge"><pre class="highlight"><code>
                      ↗│  0x00007f368439fe58: mov    0x10(%rsi,%rdi,4),%r10d  ;*aaload
                      ││                                                ; - com.github.arnaudroger.Seq2ArrayAccess::testGet@24 (line 57)
                      ││                                                ; - com.github.arnaudroger.generated.Seq2ArrayAccess_testGet_jmhTest::testGet_avgt_jmhStub@17 (line 232)
  3.33%    2.72%      ││  0x00007f368439fe5d: add    0x10(%r12,%r10,8),%rdx  ;*ladd
                      ││                                                ; - com.github.arnaudroger.Seq2ArrayAccess::testGet@33 (line 58)
                      ││                                                ; - com.github.arnaudroger.generated.Seq2ArrayAccess_testGet_jmhTest::testGet_avgt_jmhStub@17 (line 232)
                      ││                                                ; implicit exception: dispatches to 0x00007f368439ff13
  0.17%    0.15%      ││  0x00007f368439fe62: inc    %edi               ;*iinc
                      ││                                                ; - com.github.arnaudroger.Seq2ArrayAccess::testGet@35 (line 57)
                      ││                                                ; - com.github.arnaudroger.generated.Seq2ArrayAccess_testGet_jmhTest::testGet_avgt_jmhStub@17 (line 232)
  0.00%               ││  0x00007f368439fe64: cmp    %r9d,%edi
                      ╰│  0x00007f368439fe67: jl     0x00007f368439fe58  ;*if_icmpge

</code></pre>
</div>

<p>the unrolled part is loading the value in a different registers - <a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Seq2ArrayAccess10.asm#L127">rdx</a>, 
<a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Seq2ArrayAccess10.asm#L149">rax</a>, <a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Seq2ArrayAccess10.asm#L157">r8</a>, and <a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Seq2ArrayAccess10.asm#L165">r11</a>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  3.09%    4.08%     │ │  0x00007f368439fde2: mov    0x10(%r12,%r8,8),%r10d  ;*aaload
                     │ │                                                ; - com.github.arnaudroger.Seq2ArrayAccess::testGet@24 (line 57)
                     │ │                                                ; - com.github.arnaudroger.generated.Seq2ArrayAccess_testGet_jmhTest::testGet_avgt_jmhStub@17 (line 232)
  0.01%    0.00%     │ │  0x00007f368439fde7: mov    0x10(%r12,%r10,8),%rdx  ;*getfield value
                     │ │                                                ; - java.lang.Long::longValue@1 (line 1000)
                     │ │                                                ; - com.github.arnaudroger.Seq2ArrayAccess::testGet@30 (line 58)
                     │ │                                                ; - com.github.arnaudroger.generated.Seq2ArrayAccess_testGet_jmhTest::testGet_avgt_jmhStub@17 (line 232)
                     │ │                                                ; implicit exception: dispatches to 0x00007f368439ff13
</code></pre>
</div>
<div class="highlighter-rouge"><pre class="highlight"><code>  0.11%    0.07%    ││ │  0x00007f368439fe20: mov    0x14(%rsi,%rcx,4),%r11d  ;*aaload
                    ││ │                                                ; - com.github.arnaudroger.Seq2ArrayAccess::testGet@24 (line 57)
                    ││ │                                                ; - com.github.arnaudroger.generated.Seq2ArrayAccess_testGet_jmhTest::testGet_avgt_jmhStub@17 (line 232)
  0.00%    0.01%    ││ │  0x00007f368439fe25: mov    0x10(%r12,%r11,8),%rax  ;*getfield value
                    ││ │                                                ; - java.lang.Long::longValue@1 (line 1000)
                    ││ │                                                ; - com.github.arnaudroger.Seq2ArrayAccess::testGet@30 (line 58)
                    ││ │                                                ; - com.github.arnaudroger.generated.Seq2ArrayAccess_testGet_jmhTest::testGet_avgt_jmhStub@17 (line 232)
                    ││ │                                                ; implicit exception: dispatches to 0x00007f368439ff13
  2.11%    2.34%    ││ │  0x00007f368439fe2a: mov    0x18(%rsi,%rcx,4),%r8d  ;*aaload
                    ││ │                                                ; - com.github.arnaudroger.Seq2ArrayAccess::testGet@24 (line 57)
                    ││ │                                                ; - com.github.arnaudroger.generated.Seq2ArrayAccess_testGet_jmhTest::testGet_avgt_jmhStub@17 (line 232)
  5.45%    4.88%    ││ │  0x00007f368439fe2f: mov    0x10(%r12,%r8,8),%r8  ;*getfield value
                    ││ │                                                ; - java.lang.Long::longValue@1 (line 1000)
                    ││ │                                                ; - com.github.arnaudroger.Seq2ArrayAccess::testGet@30 (line 58)
                    ││ │                                                ; - com.github.arnaudroger.generated.Seq2ArrayAccess_testGet_jmhTest::testGet_avgt_jmhStub@17 (line 232)
                    ││ │                                                ; implicit exception: dispatches to 0x00007f368439ff13
  1.33%    1.37%    ││ │  0x00007f368439fe34: mov    0x1c(%rsi,%rcx,4),%r11d  ;*aaload
                    ││ │                                                ; - com.github.arnaudroger.Seq2ArrayAccess::testGet@24 (line 57)
                    ││ │                                                ; - com.github.arnaudroger.generated.Seq2ArrayAccess_testGet_jmhTest::testGet_avgt_jmhStub@17 (line 232)
                    ││ │  0x00007f368439fe39: mov    0x10(%r12,%r11,8),%r11  ;*getfield value
                    ││ │                                                ; - java.lang.Long::longValue@1 (line 1000)
                    ││ │                                                ; - com.github.arnaudroger.Seq2ArrayAccess::testGet@30 (line 58)
                    ││ │                                                ; - com.github.arnaudroger.generated.Seq2ArrayAccess_testGet_jmhTest::testGet_avgt_jmhStub@17 (line 232)
                    ││ │                                                ; implicit exception: dispatches to 0x00007f368439ff13
</code></pre>
</div>
<p>and then does all the <a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Seq2ArrayAccess10.asm#L170-L172">adds</a> in one go.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  2.03%    2.06%    ││ │  0x00007f368439fe3e: add    %rax,%rdx
  5.28%    4.58%    ││ │  0x00007f368439fe41: add    %r8,%rdx
  3.06%    2.91%    ││ │  0x00007f368439fe44: add    %r11,%rdx          ;*ladd
                    ││ │                                                ; - com.github.arnaudroger.Seq2ArrayAccess::testGet@33 (line 58)
                    ││ │                                                ; - com.github.arnaudroger.generated.Seq2ArrayAccess_testGet_jmhTest::testGet_avgt_jmhStub@17 (line 232)
</code></pre>
</div>

<h4 id="seq2list-asm"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Seq2ListAccess10.asm#L124">Seq2List asm</a></h4>

<p>the List loop is also <a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Seq2ListAccess10.asm#L123-L282">unrolled</a>,
  but the <code class="highlighter-rouge">longValue()</code> and <a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Seq2ListAccess10.asm#L161">add</a> 
are done <a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Seq2ListAccess10.asm#L192">sequentially</a> 
on the same register <a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Seq2ListAccess10.asm#L220">rdx</a>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>
  7.88%    7.01%    │     │ │  0x00007f8e687c5924: lea    (%r12,%rdi,8),%rax  ;*aaload
                    │     │ │                                                ; - java.util.ArrayList::elementData@5 (line 418)
                    │     │ │                                                ; - java.util.ArrayList::get@7 (line 431)
                    │     │ │                                                ; - com.github.arnaudroger.Seq2ListAccess::testIndexed@25 (line 63)
                    │     │ │                                                ; - com.github.arnaudroger.generated.Seq2ListAccess_testIndexed_jmhTest::testIndexed_avgt_jmhStub@17 (line 232)
  0.00%    0.00%    │     │ │  0x00007f8e687c5928: cmp    $0xf80022ae,%ebx   ;   {metadata(&amp;apos;java/lang/Long&amp;apos;)}
                    │     │ │  0x00007f8e687c592e: jne    0x00007f8e687c5c3f  ;*checkcast
                    │     │ │                                                ; - com.github.arnaudroger.Seq2ListAccess::testIndexed@28 (line 63)
                    │     │ │                                                ; - com.github.arnaudroger.generated.Seq2ListAccess_testIndexed_jmhTest::testIndexed_avgt_jmhStub@17 (line 232)
  2.19%    1.86%    │     │ │  0x00007f8e687c5934: add    0x10(%rax),%rdx    ;*ladd
                    │     │ │                                                ; - com.github.arnaudroger.Seq2ListAccess::testIndexed@34 (line 63)
                    │     │ │                                                ; - com.github.arnaudroger.generated.Seq2ListAccess_testIndexed_jmhTest::testIndexed_avgt_jmhStub@17 (line 232)
  
  ....
  2.05%    1.25%     │   ││ │  0x00007f8e687c596a: lea    (%r12,%rbx,8),%rax  ;*aaload
                     │   ││ │                                                ; - java.util.ArrayList::elementData@5 (line 418)
                     │   ││ │                                                ; - java.util.ArrayList::get@7 (line 431)
                     │   ││ │                                                ; - com.github.arnaudroger.Seq2ListAccess::testIndexed@25 (line 63)
                     │   ││ │                                                ; - com.github.arnaudroger.generated.Seq2ListAccess_testIndexed_jmhTest::testIndexed_avgt_jmhStub@17 (line 232)
  0.58%    0.63%     │   ││ │  0x00007f8e687c596e: cmp    $0xf80022ae,%r10d  ;   {metadata(&amp;apos;java/lang/Long&amp;apos;)}
                     │   ││ │  0x00007f8e687c5975: jne    0x00007f8e687c5c3f  ;*checkcast
                     │   ││ │                                                ; - com.github.arnaudroger.Seq2ListAccess::testIndexed@28 (line 63)
                     │   ││ │                                                ; - com.github.arnaudroger.generated.Seq2ListAccess_testIndexed_jmhTest::testIndexed_avgt_jmhStub@17 (line 232)
  1.65%    1.61%     │   ││ │  0x00007f8e687c597b: add    0x10(%rax),%rdx    ;*ladd
                     │   ││ │                                                ; - com.github.arnaudroger.Seq2ListAccess::testIndexed@34 (line 63)
                     │   ││ │                                                ; - com.github.arnaudroger.generated.Seq2ListAccess_testIndexed_jmhTest::testIndexed_avgt_jmhStub@17 (line 232)
  ...                      
  1.49%    1.05%     ││  ││ │  0x00007f8e687c5995: lea    (%r12,%r10,8),%rax  ;*aaload
                     ││  ││ │                                                ; - java.util.ArrayList::elementData@5 (line 418)
                     ││  ││ │                                                ; - java.util.ArrayList::get@7 (line 431)
                     ││  ││ │                                                ; - com.github.arnaudroger.Seq2ListAccess::testIndexed@25 (line 63)
                     ││  ││ │                                                ; - com.github.arnaudroger.generated.Seq2ListAccess_testIndexed_jmhTest::testIndexed_avgt_jmhStub@17 (line 232)
  1.64%    0.94%     ││  ││ │  0x00007f8e687c5999: cmp    $0xf80022ae,%esi   ;   {metadata(&amp;apos;java/lang/Long&amp;apos;)}
                     ││  ││ │  0x00007f8e687c599f: jne    0x00007f8e687c5c3c  ;*checkcast
                     ││  ││ │                                                ; - com.github.arnaudroger.Seq2ListAccess::testIndexed@28 (line 63)
                     ││  ││ │                                                ; - com.github.arnaudroger.generated.Seq2ListAccess_testIndexed_jmhTest::testIndexed_avgt_jmhStub@17 (line 232)
  0.78%    0.74%     ││  ││ │  0x00007f8e687c59a9: add    0x10(%rax),%rdx    ;*ladd
  ...
                     ││  ││ │                                                ; - com.github.arnaudroger.Seq2ListAccess::testIndexed@34 (line 63)
                     ││  ││ │                                                ; - com.github.arnaudroger.generated.Seq2ListAccess_testIndexed_jmhTest::testIndexed_avgt_jmhStub@17 (line 232)
  0.97%    0.38%     │││ ││ │  0x00007f8e687c59ba: lea    (%r12,%rsi,8),%rax  ;*aaload
                     │││ ││ │                                                ; - java.util.ArrayList::elementData@5 (line 418)
                     │││ ││ │                                                ; - java.util.ArrayList::get@7 (line 431)
                     │││ ││ │                                                ; - com.github.arnaudroger.Seq2ListAccess::testIndexed@25 (line 63)
                     │││ ││ │                                                ; - com.github.arnaudroger.generated.Seq2ListAccess_testIndexed_jmhTest::testIndexed_avgt_jmhStub@17 (line 232)
  0.45%    0.29%     │││ ││ │  0x00007f8e687c59be: cmp    $0xf80022ae,%r10d  ;   {metadata(&amp;apos;java/lang/Long&amp;apos;)}
                     │││ ││ │  0x00007f8e687c59c5: jne    0x00007f8e687c5c36  ;*checkcast
                     │││ ││ │                                                ; - com.github.arnaudroger.Seq2ListAccess::testIndexed@28 (line 63)
                     │││ ││ │                                                ; - com.github.arnaudroger.generated.Seq2ListAccess_testIndexed_jmhTest::testIndexed_avgt_jmhStub@17 (line 232)
  1.56%    0.09%     │││ ││ │  0x00007f8e687c59cf: add    0x10(%rax),%rdx    ;*ladd
                     │││ ││ │                                                ; - com.github.arnaudroger.Seq2ListAccess::testIndexed@34 (line 63)
                     │││ ││ │                                                ; - com.github.arnaudroger.generated.Seq2ListAccess_testIndexed_jmhTest::testIndexed_avgt_jmhStub@17 (line 232)
  ...
  0.98%    0.50%     ││││││ │  0x00007f8e687c59dc: lea    (%r12,%rbx,8),%rax  ;*aaload
                     ││││││ │                                                ; - java.util.ArrayList::elementData@5 (line 418)
                     ││││││ │                                                ; - java.util.ArrayList::get@7 (line 431)
                     ││││││ │                                                ; - com.github.arnaudroger.Seq2ListAccess::testIndexed@25 (line 63)
                     ││││││ │                                                ; - com.github.arnaudroger.generated.Seq2ListAccess_testIndexed_jmhTest::testIndexed_avgt_jmhStub@17 (line 232)
  1.61%    0.20%     ││││││ │  0x00007f8e687c59e0: cmp    $0xf80022ae,%r10d  ;   {metadata(&amp;apos;java/lang/Long&amp;apos;)}
                     ││││││ │  0x00007f8e687c59e7: jne    0x00007f8e687c5c30  ;*checkcast
                     ││││││ │                                                ; - com.github.arnaudroger.Seq2ListAccess::testIndexed@28 (line 63)
                     ││││││ │                                                ; - com.github.arnaudroger.generated.Seq2ListAccess_testIndexed_jmhTest::testIndexed_avgt_jmhStub@17 (line 232)
  1.38%    0.59%     ││││││ │  0x00007f8e687c59ed: add    0x10(%rax),%rdx    ;*ladd
                     ││││││ │                                                ; - com.github.arnaudroger.Seq2ListAccess::testIndexed@34 (line 63)
                     ││││││ │                                                ; - com.github.arnaudroger.generated.Seq2ListAccess_testIndexed_jmhTest::testIndexed_avgt_jmhStub@17 (line 232)

</code></pre>
</div>

<p>The <code class="highlighter-rouge">checkcast</code>s are still there, but no more implicit boundary check.
Which is closer to what you expect in a real application.</p>

<p>Iterating over the ArrayList introduce a lot more instruction due to the <code class="highlighter-rouge">checkcast</code> reducing the opportunity to keep the cpu busy.
But then why are the perf equivalent on the 1000000 sized array?</p>

<h4 id="perfnorm"><a href="https://github.com/arnaudroger/blog_samples/blob/master/05_arraylistvsarray/Seq2.perfnorm#L735">perfnorm</a></h4>

<div class="highlighter-rouge"><pre class="highlight"><code>java -jar target/benchmark.jar -f 1 -prof perfnorm
</code></pre>
</div>

<p>I extracted the Clock Per Instruction - the lower the better -, L1 cache misses - the lower the better -, and number of instructions for the perfnorm run in the following table.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Seq2ArrayAccess.testGet:CPI                            10  avgt             0.343              #/op
Seq2ArrayAccess.testGet:L1-dcache-load-misses          10  avgt            ≈ 10⁻⁴              #/op
Seq2ArrayAccess.testGet:instructions                   10  avgt            84.044              #/op

Seq2ListAccess.testIndexed:instructions                10  avgt           146.788              #/op
Seq2ListAccess.testIndexed:CPI                         10  avgt             0.295              #/op
Seq2ListAccess.testIndexed:L1-dcache-load-misses       10  avgt             0.002              #/op

Seq2ArrayAccess.testGet:CPI                          1000  avgt             0.317              #/op
Seq2ArrayAccess.testGet:L1-dcache-load-misses        1000  avgt             8.089              #/op
Seq2ArrayAccess.testGet:instructions                 1000  avgt          3794.591              #/op

Seq2ListAccess.testIndexed:CPI                       1000  avgt             0.259              #/op
Seq2ListAccess.testIndexed:L1-dcache-load-misses     1000  avgt             9.929              #/op
Seq2ListAccess.testIndexed:instructions              1000  avgt          8562.880              #/op

Seq2ArrayAccess.testGet:instructions              1000000  avgt       3747496.801              #/op
Seq2ArrayAccess.testGet:CPI                       1000000  avgt             1.634              #/op
Seq2ArrayAccess.testGet:L1-dcache-load-misses     1000000  avgt        441021.756              #/op

Seq2ListAccess.testIndexed:instructions           1000000  avgt       8514529.296              #/op
Seq2ListAccess.testIndexed:CPI                    1000000  avgt             0.741              #/op
Seq2ListAccess.testIndexed:L1-dcache-load-misses  1000000  avgt        439508.067              #/op

</code></pre>
</div>

<p>With 10 and 1000 elements the number of cache misses is pretty low, the number of instruction and the CPI are lower for Array - no wonder it’s faster less to do, and less cycle to do it -.
But on the 1000000 size array there are loads of cache misses. They end-up dominating the performance, increasing the CPI to 1.6 for the Array. The only reason the ArrayList does not score as bad is because it has a lot more instructions.</p>

    </div>

    <div class="PageNavigation">
        
        <a class="prev" href="/blog/2017/07/17/deep-dive-clone-vs-copy.html">&laquo; Deep dive into the clone vs copy question</a>
        
        
    </div>


    <div id="disqus_thread"></div>
<script>

/**
 *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables */
/*
var disqus_config = function () {
    this.page.url = 'http://arnaudroger.github.io/blog/2018/06/01/arraylist-vs-arrays.html';  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = '/2018/06/01/arraylist-vs-arrays'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//arogerblog.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</article>

      </div>
    </main>

    <footer class="site-footer">

    <div class="wrapper">

        <h2 class="footer-heading">Eat Sleep Code Repeat.</h2>

        <div class="footer-col-wrapper">
            <div class="footer-col footer-col-1">
                <ul class="contact-list">
                    <li>Eat Sleep Code Repeat.</li>
                    <li><a href="mailto:arnaud.roger@gmail.com">arnaud.roger@gmail.com</a></li>
                </ul>
            </div>

            <div class="footer-col footer-col-2">
                <ul class="social-media-list">
                    
                    <li>
                        <a href="https://github.com/arnaudroger"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">arnaudroger</span></a>

                    </li>
                    

                    
                    <li>
                        <a href="https://twitter.com/arnaudroger"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">arnaudroger</span></a>

                    </li>
                    
                </ul>
            </div>

            <div class="footer-col footer-col-3">
                <p>Rambling of an old java developer.</p>
            </div>
        </div>

    </div>
</footer>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83272639-1', 'auto');
  ga('send', 'pageview');

</script>



  </body>

</html>
